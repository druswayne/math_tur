{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="text-center">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
                </div>
                <div class="card-body">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }}">{{ message }}</div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                    
                    {% if teacher_invite_link %}
                        <div class="alert alert-info">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-chalkboard-teacher me-2"></i>
                                <div>
                                    <strong>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é —É—á–∏—Ç–µ–ª—è</strong><br>
                                    <small>–í—ã —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç–µ—Å—å –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é —É—á–∏—Ç–µ–ª—è. –ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤—ã –±—É–¥–µ—Ç–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —ç—Ç–æ–º—É —É—á–∏—Ç–µ–ª—é.</small>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    
                    <form method="POST" action="{{ url_for('register') }}" id="registerForm">
                        {% if teacher_code %}
                            <input type="hidden" name="teacher_code" value="{{ teacher_code }}">
                        {% endif %}
                        <div class="mb-3">
                            <label for="username" class="form-label">–õ–æ–≥–∏–Ω</label>
                            <div class="input-group">
                            <input type="text" class="form-control" id="username" name="username" required>
                                <span class="input-group-text validation-icon" id="username-icon">
                                    <i class="fas fa-spinner fa-spin" style="display: none;"></i>
                                    <i class="fas fa-check text-success" style="display: none;"></i>
                                    <i class="fas fa-times text-danger" style="display: none;"></i>
                                </span>
                            </div>
                            <div class="form-text">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã –ª–∞—Ç–∏–Ω—Å–∫–æ–≥–æ –∞–ª—Ñ–∞–≤–∏—Ç–∞ (a-z), —Ü–∏—Ñ—Ä—ã (0-9) –∏ –∑–Ω–∞–∫ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è _.</div>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">–ü–∞—Ä–æ–ª—å</label>
                            <div class="input-group">
                            <input type="password" class="form-control" id="password" name="password" required>
                                <button type="button" class="btn btn-outline-secondary" id="togglePassword" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <span class="input-group-text validation-icon" id="password-icon">
                                    <i class="fas fa-check text-success" style="display: none;"></i>
                                    <i class="fas fa-times text-danger" style="display: none;"></i>
                                </span>
                            </div>
                            <div class="password-requirements mt-2" id="password-requirements">
                                <small class="text-muted">–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–∞—Ä–æ–ª—é:</small>
                                <ul class="list-unstyled mt-1 mb-0">
                                    <li id="req-length"><i class="fas fa-circle text-muted"></i> –ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤</li>
                                    <li id="req-uppercase"><i class="fas fa-circle text-muted"></i> –ó–∞–≥–ª–∞–≤–Ω–∞—è –±—É–∫–≤–∞</li>
                                    <li id="req-lowercase"><i class="fas fa-circle text-muted"></i> –°—Ç—Ä–æ—á–Ω–∞—è –±—É–∫–≤–∞</li>
                                    <li id="req-number"><i class="fas fa-circle text-muted"></i> –¶–∏—Ñ—Ä–∞</li>
                                    <li id="req-special"><i class="fas fa-circle text-muted"></i> –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–∏–º–≤–æ–ª (!@#$%^&*()_+-=[]{}|;:,.<>?)</li>
                                </ul>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="confirm_password" class="form-label">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                            <div class="input-group">
                            <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                                <button type="button" class="btn btn-outline-secondary" id="toggleConfirmPassword" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <span class="input-group-text validation-icon" id="confirm_password-icon">
                                    <i class="fas fa-check text-success" style="display: none;"></i>
                                    <i class="fas fa-times text-danger" style="display: none;"></i>
                                </span>
                            </div>
                        </div>
                        <hr class="my-4" style="border: 2px solid grey; border-radius: 1px; opacity: 0.8; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div class="mb-3">
                            <label for="student_name" class="form-label">–§–∞–º–∏–ª–∏—è –∏ –∏–º—è —É—á–∞—â–µ–≥–æ—Å—è</label>
                            <div class="input-group">
                            <input type="text" class="form-control" id="student_name" name="student_name" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω" required>
                                <span class="input-group-text validation-icon" id="student_name-icon">
                                    <i class="fas fa-check text-success" style="display: none;"></i>
                                    <i class="fas fa-times text-danger" style="display: none;"></i>
                                </span>
                            </div>
                            <div class="form-text">–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é –∏ –∏–º—è —É—á–∞—â–µ–≥–æ—Å—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ú–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞.</div>
                        </div>
                        <div class="mb-3">
                            <label for="parent_name" class="form-label">–§–ò–û –∑–∞–∫–æ–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è (—Ä–æ–¥–∏—Ç–µ–ª—è)</label>
                            <div class="input-group">
                            <input type="text" class="form-control" id="parent_name" name="parent_name" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á" required>
                                <span class="input-group-text validation-icon" id="parent_name-icon">
                                    <i class="fas fa-check text-success" style="display: none;"></i>
                                    <i class="fas fa-times text-danger" style="display: none;"></i>
                                </span>
                            </div>
                            <div class="form-text">–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é, –∏–º—è –∏ –æ—Ç—á–µ—Å—Ç–≤–æ –∑–∞–∫–æ–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ú–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞.</div>
                        </div>

                        <div class="mb-3">
                            <label for="phone" class="form-label">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                            <div class="input-group">
                                <select class="form-select" id="phone_country" style="max-width: 120px;">
                                    <option value="+375">üáßüáæ +375</option>
                                    <option value="+7">üá∑üá∫ +7</option>
                                </select>
                                <input type="tel" class="form-control" id="phone" name="phone" placeholder="291234567" required>
                                <span class="input-group-text validation-icon" id="phone-icon">
                                    <i class="fas fa-check text-success" style="display: none;"></i>
                                    <i class="fas fa-times text-danger" style="display: none;"></i>
                                </span>
                            </div>
                            <div class="form-text">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –±–µ–∑ –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω—ã (–∫–æ–¥ –≤—ã–±—Ä–∞–Ω –≤—ã—à–µ)</div>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <div class="input-group">
                            <input type="email" class="form-control" id="email" name="email" placeholder="example@email.com" required>
                                <span class="input-group-text validation-icon" id="email-icon">
                                    <i class="fas fa-spinner fa-spin" style="display: none;"></i>
                                    <i class="fas fa-check text-success" style="display: none;"></i>
                                    <i class="fas fa-times text-danger" style="display: none;"></i>
                                </span>
                            </div>
                        </div>
                               <hr class="my-4" style="border: 2px solid grey; border-radius: 1px; opacity: 0.8; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                         <!-- –ü–æ–ª–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —É—á—Ä–µ–∂–¥–µ–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è -->
                        <div class="mb-3">
                            <label for="educational_institution" class="form-label">–£—á—Ä–µ–∂–¥–µ–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="educational_institution_search" 
                                       placeholder="–°—Ä–µ–¥–Ω—è—è —à–∫–æ–ª–∞ ‚Ññ2 –≥. –ú–∏–Ω—Å–∫" autocomplete="off" required>
                                <span class="input-group-text validation-icon" id="educational_institution-icon">
                                    <i class="fas fa-check text-success" style="display: none;"></i>
                                    <i class="fas fa-times text-danger" style="display: none;"></i>
                                </span>
                            </div>
                            
                            <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è ID –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —É—á—Ä–µ–∂–¥–µ–Ω–∏—è -->
                            <input type="hidden" id="educational_institution_id" name="educational_institution_id">
                            
                            <!-- –ü–æ–ª–µ –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —É—á—Ä–µ–∂–¥–µ–Ω–∏—è -->
                            <input type="hidden" id="educational_institution_name" name="educational_institution_name">
                            
                            <!-- –°–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ -->
                            <div id="institution_results" class="list-group position-absolute w-100" style="z-index: 1000; display: none; max-height: 200px; overflow-y: auto;"></div>
                            
                            <div class="form-text">–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —É—á—Ä–µ–∂–¥–µ–Ω–∏—è, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–µ - –æ–Ω–æ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ</div>
                        </div>
                        <div class="mb-3">
                            <label for="category" class="form-label">–ö–ª–∞—Å—Å</label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="1-2">1-2 –∫–ª–∞—Å—Å</option>
                                <option value="3">3 –∫–ª–∞—Å—Å</option>
                                <option value="4">4 –∫–ª–∞—Å—Å</option>
                                <option value="5">5 –∫–ª–∞—Å—Å</option>
                                <option value="6">6 –∫–ª–∞—Å—Å</option>
                                <option value="7">7 –∫–ª–∞—Å—Å</option>
                                <option value="8">8 –∫–ª–∞—Å—Å</option>
                                <option value="9">9 –∫–ª–∞—Å—Å</option>
                                <option value="10">10 –∫–ª–∞—Å—Å</option>
                                <option value="11">11 –∫–ª–∞—Å—Å</option>
                            </select>
                        </div>
                        {% if referral_code %}
                        <div class="mb-3">
                            <label for="referral_code" class="form-label">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥</label>
                            <input type="text" class="form-control" id="referral_code" name="referral_code" value="{{ referral_code }}" readonly>
                            <div class="form-text">–í—ã —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç–µ—Å—å –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ</div>
                        </div>
                        {% endif %}
                        {% if teacher_code %}
                        <div class="mb-3">
                            <label for="teacher_code" class="form-label">–ö–æ–¥ —É—á–∏—Ç–µ–ª—è</label>
                            <input type="text" class="form-control" id="teacher_code" name="teacher_code" value="{{ teacher_code }}" readonly>
                            <div class="form-text">–í—ã —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç–µ—Å—å –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é —É—á–∏—Ç–µ–ª—è</div>
                        </div>
                        {% endif %}
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="agree" name="agree" required>
                            <label class="form-check-label" for="agree">
                                –ú–Ω–µ —Ä–∞–∑—ä—è—Å–Ω–µ–Ω—ã –º–æ–∏ <a href="{{ url_for('rights_notification_pdf') }}" target="_blank" class="text-decoration-none">–ø—Ä–∞–≤–∞</a>, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ —è <a href="{{ url_for('consent_pdf') }}" target="_blank" class="text-decoration-none">—Å–æ–≥–ª–∞—Å–µ–Ω (–Ω–∞)</a> –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –º–æ–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                            </label>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="agree_terms" name="agree_terms" required>
                            <label class="form-check-label" for="agree_terms">
                                –Ø —Å–æ–≥–ª–∞—Å–µ–Ω(–∞) —Å <a href="{{ url_for('static', filename='–£—Å–ª–æ–≤–∏—è –ø—É–±–ª–∏—á–Ω–æ–π –æ—Ñ–µ—Ä—Ç—ã.pdf') }}" target="_blank" class="text-decoration-none">—É—Å–ª–æ–≤–∏—è–º–∏ –ø—É–±–ª–∏—á–Ω–æ–π –æ—Ñ–µ—Ä—Ç—ã</a>
                            </label>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary" id="registerButton">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                        </div>
                    </form>
                    <div class="text-center mt-3">
                        <p>–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="{{ url_for('login') }}">–í–æ–π—Ç–∏</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –û–≤–µ—Ä–ª–µ–π –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
<div id="registerOverlay" class="loading-overlay">
    <div class="loading-spinner">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
        <p class="mt-3">–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...</p>
        <p class="text-light small">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É</p>
    </div>
</div>

<style>
.category-cards {
    margin-bottom: 1rem;
}

.category-card {
    height: 120px;
    margin-bottom: 1rem;
}

.category-card .btn {
    height: 100%;
    transition: all 0.3s ease;
    border: 2px solid #dee2e6;
    background-color: #fff;
}

.category-card .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.btn-check:checked + .btn {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: white;
}

.btn-check:checked + .btn i {
    color: white;
}

.category-card i {
    color: #0d6efd;
    margin-bottom: 0.5rem;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ */
.validation-icon {
    min-width: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.validation-icon i {
    font-size: 16px;
    font-weight: bold;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è */
.input-group .form-control.is-valid {
    border-color: #198754;
    border-width: 2px;
    padding-right: calc(1.5em + 0.75rem);
    background-image: none;
    box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
    background-color: rgba(25, 135, 84, 0.05);
}

.input-group .input-group-text.is-valid {
    border-color: #198754;
    border-width: 2px;
    color: #198754;
    background-color: rgba(25, 135, 84, 0.1);
    font-weight: bold;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è */
.input-group .form-control.is-invalid {
    border-color: #dc3545;
    border-width: 2px;
    padding-right: calc(1.5em + 0.75rem);
    background-image: none;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    background-color: rgba(220, 53, 69, 0.05);
}

.input-group .input-group-text.is-invalid {
    border-color: #dc3545;
    border-width: 2px;
    color: #dc3545;
    background-color: rgba(220, 53, 69, 0.1);
    font-weight: bold;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è */
.input-group .form-control,
.input-group .input-group-text {
    transition: all 0.3s ease;
}

/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ —Å—Ç—Ä–∞–Ω—ã */
.input-group .form-select.is-valid {
    border-color: #198754;
    border-width: 2px;
    box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
    background-color: rgba(25, 135, 84, 0.05);
    background-image: none; /* –£–±–∏—Ä–∞–µ–º –≥–∞–ª–æ—á–∫—É */
}

.input-group .form-select.is-invalid {
    border-color: #dc3545;
    border-width: 2px;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    background-color: rgba(220, 53, 69, 0.05);
    background-image: none; /* –£–±–∏—Ä–∞–µ–º –∫—Ä–µ—Å—Ç–∏–∫ */
}

/* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ —Å—Ç—Ä–∞–Ω—ã —Ç–µ–ª–µ—Ñ–æ–Ω–∞ - —É–±–∏—Ä–∞–µ–º –≥–∞–ª–æ—á–∫—É –∏ –∫—Ä–µ—Å—Ç–∏–∫ */
#phone_country.is-valid {
    background-image: none !important;
    padding-right: 0.375rem !important;
}

#phone_country.is-invalid {
    background-image: none !important;
    padding-right: 0.375rem !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ */
#registerButton:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    background-color: #6c757d;
    border-color: #6c757d;
}

#registerButton:not(:disabled) {
    background-color: #0d6efd;
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    transition: all 0.3s ease;
}

#registerButton:not(:disabled):hover {
    background-color: #0b5ed7;
    border-color: #0a58ca;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.4);
    transform: translateY(-1px);
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∫–æ–Ω–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ */
.validation-icon i {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: scale(0.8);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞ —É—á—Ä–µ–∂–¥–µ–Ω–∏–π –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è */
.autocomplete-suggestions {
    position: relative;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    z-index: 1000;
    display: none;
}

.autocomplete-suggestion {
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
    transition: background-color 0.2s;
}

.autocomplete-suggestion:hover {
    background-color: #f8f9fa;
}

.autocomplete-suggestion:last-child {
    border-bottom: none;
}

.autocomplete-suggestion.selected {
    background-color: #e9ecef;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –ø–∞—Ä–æ–ª—é */
.password-requirements {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.75rem;
    margin-top: 0.5rem;
}

.password-requirements ul {
    margin-bottom: 0;
}

.password-requirements li {
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
    transition: all 0.3s ease;
}

.password-requirements li:last-child {
    margin-bottom: 0;
}

.password-requirements li i {
    margin-right: 0.5rem;
    width: 16px;
    text-align: center;
}

.password-requirements li.text-success {
    font-weight: 500;
}

.password-requirements li.text-muted {
    opacity: 0.7;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ */
.tooltip-message {
    animation: fadeIn 0.3s ease-in;
    font-size: 0.875rem;
    line-height: 1.4;
    margin-top: 0.25rem;
    padding: 0.5rem;
    border-radius: 0.375rem;
    border-left: 3px solid;
}

.tooltip-message.text-danger {
    background-color: rgba(220, 53, 69, 0.1);
    border-left-color: #dc3545;
    color: #dc3545;
}

.tooltip-message.text-warning {
    background-color: rgba(255, 193, 7, 0.1);
    border-left-color: #ffc107;
    color: #856404;
}

.tooltip-message i {
    margin-right: 0.5rem;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∫–æ–Ω–æ–∫ */
.password-requirements li i {
    transition: all 0.3s ease;
}

.password-requirements li.text-success i {
    transform: scale(1.1);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –ø–∞—Ä–æ–ª–µ–π */
.btn-outline-secondary {
    border-color: #dee2e6;
    color: #6c757d;
    background-color: #fff;
}

.btn-outline-secondary:hover {
    background-color: #f8f9fa;
    border-color: #adb5bd;
    color: #495057;
}

.btn-outline-secondary:focus {
    box-shadow: 0 0 0 0.2rem rgba(108, 117, 125, 0.25);
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∫–æ–Ω–æ–∫ –≥–ª–∞–∑ */
.btn-outline-secondary i {
    transition: all 0.3s ease;
}

.btn-outline-secondary:hover i {
    transform: scale(1.1);
}
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const registerForm = document.getElementById('registerForm');
    const registerOverlay = document.getElementById('registerOverlay');
    const registerButton = document.getElementById('registerButton');

    // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    const studentNameInput = document.getElementById('student_name');
    const parentNameInput = document.getElementById('parent_name');
    const phoneInput = document.getElementById('phone');
    const phoneCountrySelect = document.getElementById('phone_country');
    const emailInput = document.getElementById('email');
    const agreeCheckbox = document.getElementById('agree');
    const agreeTermsCheckbox = document.getElementById('agree_terms');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã
    if (!usernameInput || !passwordInput || !confirmPasswordInput || 
        !studentNameInput || !parentNameInput || !phoneInput || 
        !emailInput || !agreeCheckbox || !agreeTermsCheckbox) {
        console.error('Some form elements not found');
        return;
    }

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    let validationState = {
        username: false,
        password: false,
        confirmPassword: false,
        studentName: false,
        parentName: false,
        phone: false,
        email: false,
        educationalInstitution: false,
        agree: false,
        agree_terms: false
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏
    function showTooltip(fieldId, message, type = 'danger') {
        const input = document.getElementById(fieldId);
        if (!input) return;
        
        // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É
        const existingTooltip = document.getElementById(fieldId + '-tooltip');
        if (existingTooltip) {
            existingTooltip.remove();
        }
        
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É
        const tooltip = document.createElement('div');
        tooltip.id = fieldId + '-tooltip';
        tooltip.className = `tooltip-message text-${type}`;
        tooltip.innerHTML = `<i class="fas fa-info-circle"></i>${message}`;
        
        // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –ø–æ—Å–ª–µ –ø–æ–ª—è
        const fieldContainer = input.closest('.mb-3');
        if (fieldContainer) {
            fieldContainer.appendChild(tooltip);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–¥—Å–∫–∞–∑–∫–∏
    function removeTooltip(fieldId) {
        const existingTooltip = document.getElementById(fieldId + '-tooltip');
        if (existingTooltip) {
            existingTooltip.remove();
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
    function showValidationIcon(fieldId, isValid, isLoading = false) {
        const iconContainer = document.getElementById(fieldId + '-icon');
        const input = document.getElementById(fieldId);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
        if (!iconContainer || !input) {
            console.warn(`Elements not found for field: ${fieldId}`);
            return;
        }
        
        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∏–∫–æ–Ω–∫–∏
        iconContainer.querySelectorAll('i').forEach(icon => icon.style.display = 'none');
        
        if (isLoading) {
            const spinner = iconContainer.querySelector('.fa-spinner');
            if (spinner) spinner.style.display = 'inline-block';
            input.classList.remove('is-valid', 'is-invalid');
            iconContainer.classList.remove('is-valid', 'is-invalid');
        } else if (isValid) {
            const checkIcon = iconContainer.querySelector('.fa-check');
            if (checkIcon) checkIcon.style.display = 'inline-block';
            input.classList.add('is-valid');
            input.classList.remove('is-invalid');
            iconContainer.classList.add('is-valid');
            iconContainer.classList.remove('is-invalid');
        } else {
            const timesIcon = iconContainer.querySelector('.fa-times');
            if (timesIcon) timesIcon.style.display = 'inline-block';
            input.classList.add('is-invalid');
            input.classList.remove('is-valid');
            iconContainer.classList.add('is-invalid');
            iconContainer.classList.remove('is-valid');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–≥–∏–Ω–∞
    function validateUsername(username) {
        if (!usernameInput) return;
        
        if (username.length < 3) {
            showValidationIcon('username', false);
            validationState.username = false;
            showTooltip('username', '–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞.');
            return;
        }
        
        const usernameRegex = /^[a-zA-Z][a-zA-Z0-9_]*$/;
        if (!usernameRegex.test(username)) {
            showValidationIcon('username', false);
            validationState.username = false;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ—à–∏–±–∫–∏ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–π –ø–æ–¥—Å–∫–∞–∑–∫–∏
            if (!/^[a-zA-Z]/.test(username)) {
                showTooltip('username', '–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å –ª–∞—Ç–∏–Ω—Å–∫–æ–π –±—É–∫–≤—ã.');
            } else if (/[^a-zA-Z0-9_]/.test(username)) {
                showTooltip('username', '–õ–æ–≥–∏–Ω –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –∑–Ω–∞–∫ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è (_).');
            } else {
                showTooltip('username', '–õ–æ–≥–∏–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –∑–Ω–∞–∫ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è (_).');
            }
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ª–æ–≥–∏–Ω–∞
        showValidationIcon('username', false, true);
        
        fetch('/check-username', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ username: username })
        })
        .then(response => response.json())
        .then(data => {
            if (data.available) {
                showValidationIcon('username', true);
                validationState.username = true;
                removeTooltip('username');
            } else {
                showValidationIcon('username', false);
                validationState.username = false;
                showTooltip('username', '–≠—Ç–æ—Ç –ª–æ–≥–∏–Ω —É–∂–µ –∑–∞–Ω—è—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ü–∏—Ñ—Ä—ã/—Å–∏–º–≤–æ–ª—ã.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showValidationIcon('username', false);
            validationState.username = false;
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä–æ–ª—è
    function validatePassword(password) {
        if (!passwordInput) return;
        
        const hasMinLength = password.length >= 8;
        const hasUpperCase = /[A-Z]/.test(password);
        const hasLowerCase = /[a-z]/.test(password);
        const hasNumber = /\d/.test(password);
        const hasSpecialChar = /[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/.test(password);
        
        const isValid = hasMinLength && hasUpperCase && hasLowerCase && hasNumber && hasSpecialChar;
        showValidationIcon('password', isValid);
        validationState.password = isValid;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
        updatePasswordRequirements(hasMinLength, hasUpperCase, hasLowerCase, hasNumber, hasSpecialChar);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π
        if (confirmPasswordInput && confirmPasswordInput.value) {
            validateConfirmPassword();
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –ø–∞—Ä–æ–ª—é
    function updatePasswordRequirements(hasMinLength, hasUpperCase, hasLowerCase, hasNumber, hasSpecialChar) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥–ª–∏–Ω—ã
        const lengthIcon = document.querySelector('#req-length i');
        const lengthText = document.querySelector('#req-length');
        if (hasMinLength) {
            lengthIcon.className = 'fas fa-check text-success';
            lengthText.classList.remove('text-muted');
            lengthText.classList.add('text-success');
        } else {
            lengthIcon.className = 'fas fa-circle text-muted';
            lengthText.classList.remove('text-success');
            lengthText.classList.add('text-muted');
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥–ª–∞–≤–Ω—ã—Ö –±—É–∫–≤
        const upperIcon = document.querySelector('#req-uppercase i');
        const upperText = document.querySelector('#req-uppercase');
        if (hasUpperCase) {
            upperIcon.className = 'fas fa-check text-success';
            upperText.classList.remove('text-muted');
            upperText.classList.add('text-success');
        } else {
            upperIcon.className = 'fas fa-circle text-muted';
            upperText.classList.remove('text-success');
            upperText.classList.add('text-muted');
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç—Ä–æ—á–Ω—ã—Ö –±—É–∫–≤
        const lowerIcon = document.querySelector('#req-lowercase i');
        const lowerText = document.querySelector('#req-lowercase');
        if (hasLowerCase) {
            lowerIcon.className = 'fas fa-check text-success';
            lowerText.classList.remove('text-muted');
            lowerText.classList.add('text-success');
        } else {
            lowerIcon.className = 'fas fa-circle text-muted';
            lowerText.classList.remove('text-success');
            lowerText.classList.add('text-muted');
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ü–∏—Ñ—Ä
        const numberIcon = document.querySelector('#req-number i');
        const numberText = document.querySelector('#req-number');
        if (hasNumber) {
            numberIcon.className = 'fas fa-check text-success';
            numberText.classList.remove('text-muted');
            numberText.classList.add('text-success');
        } else {
            numberIcon.className = 'fas fa-circle text-muted';
            numberText.classList.remove('text-success');
            numberText.classList.add('text-muted');
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤
        const specialIcon = document.querySelector('#req-special i');
        const specialText = document.querySelector('#req-special');
        if (hasSpecialChar) {
            specialIcon.className = 'fas fa-check text-success';
            specialText.classList.remove('text-muted');
            specialText.classList.add('text-success');
        } else {
            specialIcon.className = 'fas fa-circle text-muted';
            specialText.classList.remove('text-success');
            specialText.classList.add('text-muted');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è
    function validateConfirmPassword() {
        if (!passwordInput || !confirmPasswordInput) return;
        
        const isValid = passwordInput.value === confirmPasswordInput.value && passwordInput.value.length > 0;
        showValidationIcon('confirm_password', isValid);
        validationState.confirmPassword = isValid;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–º–µ–Ω–∏ —É—á–∞—â–µ–≥–æ—Å—è
    function validateStudentName(name) {
        if (!studentNameInput) return;
        
        const isValid = name.trim().length >= 2 && /^[–∞-—è—ë–ê-–Ø–Å\s]+$/.test(name);
        showValidationIcon('student_name', isValid);
        validationState.studentName = isValid;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–º–µ–Ω–∏ —Ä–æ–¥–∏—Ç–µ–ª—è
    function validateParentName(name) {
        if (!parentNameInput) return;
        
        const isValid = name.trim().length >= 2 && /^[–∞-—è—ë–ê-–Ø–Å\s]+$/.test(name);
        showValidationIcon('parent_name', isValid);
        validationState.parentName = isValid;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    function validatePhone(phone) {
        if (!phoneInput || !phoneCountrySelect) return;
        
        const countryCode = phoneCountrySelect.value;
        let phoneRegex;
        
        if (countryCode === '+375') {
            // –ë–µ–ª–∞—Ä—É—Å—å: +375 + 9 —Ü–∏—Ñ—Ä
            phoneRegex = /^[0-9]{9}$/;
        } else if (countryCode === '+7') {
            // –†–æ—Å—Å–∏—è: +7 + 10 —Ü–∏—Ñ—Ä
            phoneRegex = /^[0-9]{10}$/;
        } else {
            showValidationIcon('phone', false);
            validationState.phone = false;
            return;
        }
        
        const isValid = phoneRegex.test(phone);
        
        if (!isValid) {
            showValidationIcon('phone', false);
            validationState.phone = false;
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        const fullPhone = countryCode + phone;
        showValidationIcon('phone', false, true);
        
        fetch('/check-phone', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ phone: fullPhone })
        })
        .then(async response => {
            if (response.status === 429) {
                const retryAfter = response.headers.get('Retry-After');
                const waitMsg = retryAfter ? `–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É —á–µ—Ä–µ–∑ ${retryAfter} —Å–µ–∫—É–Ω–¥` : '–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É —á—É—Ç—å –ø–æ–∑–∂–µ';
                showValidationIcon('phone', false);
                validationState.phone = false;
                console.warn('–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –ø—Ä–æ–≤–µ—Ä–æ–∫ —Ç–µ–ª–µ—Ñ–æ–Ω–∞. ' + waitMsg);
                if (typeof showNotification === 'function') {
                    showNotification('–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫', waitMsg, 'warning');
                }
                return { available: false };
            }
            return response.json();
        })
        .then(data => {
            if (data.available) {
                showValidationIcon('phone', true);
                validationState.phone = true;
                removeTooltip('phone');
            } else {
                showValidationIcon('phone', false);
                validationState.phone = false;
                showTooltip('phone', '–≠—Ç–æ—Ç –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –Ω–æ–º–µ—Ä –∏–ª–∏ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showValidationIcon('phone', false);
            validationState.phone = false;
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ email
    function validateEmail(email) {
        if (!emailInput) return;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —Ä—É—Å—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã
        const russianRegex = /[–∞-—è—ë–ê-–Ø–Å]/;
        if (russianRegex.test(email)) {
            showValidationIcon('email', false);
            validationState.email = false;
            showTooltip('email', 'Email –Ω–µ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ä—É—Å—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã.');
            return;
        }
        
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showValidationIcon('email', false);
            validationState.email = false;
            removeTooltip('email');
            return;
        }

        // –î–µ–±–∞—É–Ω—Å –∏ —á–∞—Å—Ç–æ—Ç–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å: –æ–±—Ä–∞—â–∞–µ–º—Å—è –∫ API —Ä–µ–¥–∫–æ
        showValidationIcon('email', false, true);
        fetch('/check-email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email: email })
        })
        .then(async response => {
            if (response.status === 429) {
                const retryAfter = response.headers.get('Retry-After');
                const waitMsg = retryAfter ? `–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É —á–µ—Ä–µ–∑ ${retryAfter} —Å–µ–∫—É–Ω–¥` : '–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É —á—É—Ç—å –ø–æ–∑–∂–µ';
                showValidationIcon('email', false);
                validationState.email = false;
                console.warn('–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –ø—Ä–æ–≤–µ—Ä–æ–∫ email. ' + waitMsg);
                if (typeof showNotification === 'function') {
                    showNotification('–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫', waitMsg, 'warning');
                }
                return { available: false };
            }
            return response.json();
        })
        .then(data => {
            if (data.available) {
                showValidationIcon('email', true);
                validationState.email = true;
                removeTooltip('email');
            } else {
                showValidationIcon('email', false);
                validationState.email = false;
                showTooltip('email', '–≠—Ç–æ—Ç email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∞–¥—Ä–µ—Å –∏–ª–∏ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showValidationIcon('email', false);
            validationState.email = false;
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–≥–ª–∞—Å–∏—è
    function validateAgree() {
        if (!agreeCheckbox) return;
        validationState.agree = agreeCheckbox.checked;
        
        if (!agreeTermsCheckbox) return;
        validationState.agree_terms = agreeTermsCheckbox.checked;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—á—Ä–µ–∂–¥–µ–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
    function validateEducationalInstitution() {
        const searchField = document.getElementById('educational_institution_search');
        const institutionIdField = document.getElementById('educational_institution_id');
        const institutionNameField = document.getElementById('educational_institution_name');
        
        if (!searchField) return;
        
        const searchValue = searchField.value.trim();
        const hasId = institutionIdField.value.trim() !== '';
        const hasName = institutionNameField.value.trim() !== '';
        
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–ª —Ç–µ–∫—Å—Ç, –Ω–æ –Ω–µ –≤—ã–±—Ä–∞–ª –∏–∑ —Å–ø–∏—Å–∫–∞ –∏ –Ω–µ –Ω–∞–∂–∞–ª "–°–æ–∑–¥–∞—Ç—å",
        // –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—á–∏—Ç–∞–µ–º —ç—Ç–æ –Ω–æ–≤—ã–º —É—á—Ä–µ–∂–¥–µ–Ω–∏–µ–º
        if (searchValue.length >= 2 && !hasId && !hasName) {
            institutionNameField.value = searchValue;
        }
        
        // –ü–æ–ª–µ –≤–∞–ª–∏–¥–Ω–æ, –µ—Å–ª–∏ –µ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –ø–æ–∏—Å–∫–µ –ò (–µ—Å—Ç—å ID –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —É—á—Ä–µ–∂–¥–µ–Ω–∏—è –ò–õ–ò –µ—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —É—á—Ä–µ–∂–¥–µ–Ω–∏—è)
        const isValid = searchValue.length >= 2 && (hasId || institutionNameField.value.trim() !== '');
        
        showValidationIcon('educational_institution', isValid);
        validationState.educationalInstitution = isValid;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ–π —Ñ–æ—Ä–º—ã
    function validateForm() {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–≥–ª–∞—Å–∏–π –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π
        validateAgree();
        const allValid = Object.values(validationState).every(state => state === true);
        registerButton.disabled = !allValid;
        return allValid;
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    let usernameTimeout;
    if (usernameInput) {
        usernameInput.addEventListener('input', function() {
            clearTimeout(usernameTimeout);
            // –£–¥–∞–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –≤–≤–æ–¥–∞
            removeTooltip('username');
            usernameTimeout = setTimeout(() => {
                validateUsername(this.value);
                validateForm();
            }, 500);
        });
    }

    if (passwordInput) {
        passwordInput.addEventListener('input', function() {
            validatePassword(this.value);
            validateForm();
        });
    }

    if (confirmPasswordInput) {
        confirmPasswordInput.addEventListener('input', function() {
            validateConfirmPassword();
            validateForm();
        });
    }

    // –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –ø–∞—Ä–æ–ª–µ–π
    const togglePassword = document.getElementById('togglePassword');
    const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');

    if (togglePassword) {
        togglePassword.addEventListener('click', function() {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            
            // –ú–µ–Ω—è–µ–º –∏–∫–æ–Ω–∫—É
            const icon = this.querySelector('i');
            icon.className = type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash';
        });
    }

    if (toggleConfirmPassword) {
        toggleConfirmPassword.addEventListener('click', function() {
            const type = confirmPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            confirmPasswordInput.setAttribute('type', type);
            
            // –ú–µ–Ω—è–µ–º –∏–∫–æ–Ω–∫—É
            const icon = this.querySelector('i');
            icon.className = type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash';
        });
    }

    if (studentNameInput) {
        studentNameInput.addEventListener('input', function() {
            validateStudentName(this.value);
            validateForm();
        });
    }

    if (parentNameInput) {
        parentNameInput.addEventListener('input', function() {
            validateParentName(this.value);
            validateForm();
        });
    }

    if (phoneInput) {
        phoneInput.addEventListener('input', function() {
            // –£–¥–∞–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –≤–≤–æ–¥–∞
            removeTooltip('phone');
            validatePhone(this.value);
            validateForm();
        });
    }

    if (phoneCountrySelect) {
        phoneCountrySelect.addEventListener('change', function() {
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω—ã
            updatePhonePlaceholder();
            validatePhone(phoneInput.value);
            validateForm();
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    function updatePhonePlaceholder() {
        const countryCode = phoneCountrySelect.value;
        const phoneInput = document.getElementById('phone');
        
        if (countryCode === '+375') {
            // –ë–µ–ª–∞—Ä—É—Å—å: 9 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ –∫–æ–¥–∞
            phoneInput.placeholder = '291234567';
        } else if (countryCode === '+7') {
            // –†–æ—Å—Å–∏—è: 10 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ –∫–æ–¥–∞
            phoneInput.placeholder = '9123456789';
        }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    updatePhonePlaceholder();

    let emailTimeout;
    if (emailInput) {
        emailInput.addEventListener('input', function() {
            clearTimeout(emailTimeout);
            // –£–¥–∞–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –≤–≤–æ–¥–∞
            removeTooltip('email');
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —Ä—É—Å—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã —Å—Ä–∞–∑—É –ø—Ä–∏ –≤–≤–æ–¥–µ
            const russianRegex = /[–∞-—è—ë–ê-–Ø–Å]/;
            if (russianRegex.test(this.value)) {
                showValidationIcon('email', false);
                validationState.email = false;
                showTooltip('email', 'Email –Ω–µ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ä—É—Å—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã.');
                validateForm();
                return;
            }
            emailTimeout = setTimeout(() => {
                validateEmail(this.value);
                validateForm();
            }, 500);
        });
    }

    if (agreeCheckbox) {
        agreeCheckbox.addEventListener('change', function() {
            validateAgree();
            validateForm();
        });
    }

    if (agreeTermsCheckbox) {
        agreeTermsCheckbox.addEventListener('change', function() {
            validateAgree();
            validateForm();
        });
    }



    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    registerForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!validateForm()) {
            return;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã –∫ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        const phoneCountry = document.getElementById('phone_country').value;
        
        // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω—ã
        const hiddenPhoneCountryField = document.createElement('input');
        hiddenPhoneCountryField.type = 'hidden';
        hiddenPhoneCountryField.name = 'phone_country';
        hiddenPhoneCountryField.value = phoneCountry;
        registerForm.appendChild(hiddenPhoneCountryField);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π
        registerOverlay.style.display = 'flex';
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        registerButton.disabled = true;
        
        // –î–∞–µ–º –≤—Ä–µ–º—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è display: flex
        setTimeout(() => {
            registerOverlay.style.opacity = '1';
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
            setTimeout(() => {
                registerForm.submit();
            }, 200);
        }, 50);
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è - –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
    registerButton.disabled = true;

    // === –ê–í–¢–û–ö–û–ú–ü–õ–ò–¢ –£–ß–†–ï–ñ–î–ï–ù–ò–Ø –û–ë–†–ê–ó–û–í–ê–ù–ò–Ø ===
    const searchField = document.getElementById('educational_institution_search');
    const resultsContainer = document.getElementById('institution_results');
    const institutionIdField = document.getElementById('educational_institution_id');
    const institutionNameField = document.getElementById('educational_institution_name');
    
    let searchTimeout;
    
    if (searchField) {
        searchField.addEventListener('input', function() {
            const query = this.value.trim();
            
            clearTimeout(searchTimeout);
            
            // –í—ã–∑—ã–≤–∞–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏
            validateEducationalInstitution();
            validateForm();
            
            if (query.length < 2) {
                resultsContainer.style.display = 'none';
                institutionIdField.value = '';
                institutionNameField.value = '';
                return;
            }
            
            searchTimeout = setTimeout(() => {
                fetch(`/api/search-educational-institutions?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        resultsContainer.innerHTML = '';
                        
                        if (data.institutions.length > 0) {
                            data.institutions.forEach(institution => {
                                const item = document.createElement('button');
                                item.type = 'button';
                                item.className = 'list-group-item list-group-item-action';
                                item.innerHTML = `
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">${institution.name}</h6>
                                    </div>
                                    <p class="mb-1">${institution.address}</p>
                                `;
                                
                                item.addEventListener('click', function() {
                                    searchField.value = institution.name;
                                    institutionIdField.value = institution.id;
                                    institutionNameField.value = '';
                                    resultsContainer.style.display = 'none';
                                    validateEducationalInstitution();
                                    validateForm();
                                });
                                
                                resultsContainer.appendChild(item);
                            });
                            
                            resultsContainer.style.display = 'block';
                        } else {
                            // –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ —É—á—Ä–µ–∂–¥–µ–Ω–∏–µ
                            const item = document.createElement('button');
                            item.type = 'button';
                            item.className = 'list-group-item list-group-item-action text-muted';
                            item.innerHTML = `
                                <div class="text-center">
                                    <i class="fas fa-plus me-2"></i>
                                    –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ: "${query}"
                                </div>
                            `;
                            
                            item.addEventListener('click', function() {
                                searchField.value = query;
                                institutionIdField.value = '';
                                institutionNameField.value = query;
                                resultsContainer.style.display = 'none';
                                validateEducationalInstitution();
                                validateForm();
                            });
                            
                            resultsContainer.appendChild(item);
                            resultsContainer.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
                        resultsContainer.style.display = 'none';
                    });
            }, 300);
        });

        // –°–∫—Ä—ã—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏
        document.addEventListener('click', function(e) {
            if (!searchField.contains(e.target) && !resultsContainer.contains(e.target)) {
                resultsContainer.style.display = 'none';
            }
        });
    }
});
</script>
{% endblock %} 