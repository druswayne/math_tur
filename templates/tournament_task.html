{% extends "base.html" %}

{% block content %}
<!-- Оверлей загрузки -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Загрузка...</span>
        </div>
        <p class="mt-3">Загрузка задачи...</p>
        <p class="text-light small">Пожалуйста, не закрывайте страницу</p>
    </div>
</div>

<!-- Оверлей нарушения -->
<div id="violationOverlay" class="loading-overlay" style="display:none; z-index: 9999;">
    <div class="loading-spinner">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Нарушение...</span>
        </div>
        <p class="mt-3 text-danger" style="font-size:1.3rem; font-weight:600;">Нарушение зафиксировано. Ожидайте</p>
    </div>
</div>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <!-- Таймер и прогресс турнира -->
            <div class="card mb-4">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <!-- Таймер (слева) -->
                        <div class="d-flex align-items-center">
                            <div class="timer-progress-item">
                                <small class="text-muted d-block mb-1">До окончания:</small>
                                <div class="countdown-timer-compact">
                                    <span class="countdown-number" id="hours">00</span>:
                                    <span class="countdown-number" id="minutes">00</span>:
                                    <span class="countdown-number" id="seconds">00</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Прогресс (справа) -->
                        <div class="d-flex align-items-center">
                            <div class="timer-progress-item text-end">
                                <small class="text-muted d-block mb-1">Прогресс:</small>
                                <div class="progress-compact">
                                    <span class="progress-text">{{ solved_tasks_count }}/{{ total_tasks }}</span>
                                    <div class="progress-bar-compact">
                                        <div class="progress-fill" 
                                             style="width: {{ (solved_tasks_count / total_tasks * 100)|round(1) }}%">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Задача -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-end mb-3">
                        <button type="button" class="btn btn-danger btn-sm" id="skipTaskBtn">
                            <i class="fas fa-times me-1"></i>Пропустить
                        </button>
                    </div>
                    
                    <div class="task-content">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="mb-0 no-select flex-grow-1">{{ task.title }}</h4>
                            <span class="badge bg-primary fs-5">{{ task.points }} баллов</span>
                        </div>
                        <div class="mb-4 no-select">{{ task.description|nl2br }}</div>

                        {% if task.image %}
                        <div class="text-center mb-4">
                            <div class="image-container-wrapper" id="taskImageContainer">
                                <div class="image-loading" id="imageLoading">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Загрузка изображения...</span>
                                    </div>
                                    <p class="mt-2 text-muted">Загрузка изображения...</p>
                                </div>
                                <img src="https://s3.twcstorage.ru/5e984fdc-c435406b-ee7b-4296-aaed-0ceae9456f42/tasks/{{ task.image }}"
                                     class="img-fluid task-image"
                                     alt="Изображение к задаче"
                                     data-bs-toggle="modal"
                                     data-bs-target="#imageModal"
                                     id="taskImage"
                                     style="cursor: pointer; max-height: 400px; object-fit: contain; display: none;">
                                <div class="image-error" id="imageError" style="display: none;">
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>Ошибка загрузки изображения</strong>
                                        <p class="mb-2">Изображение не удалось загрузить</p>
                                        <button type="button" class="btn btn-sm btn-outline-primary" id="retryImageBtn">
                                            <i class="fas fa-redo me-1"></i>Повторить попытку
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-2" id="imageInstructions">
                                <small class="text-muted">
                                    <i class="fas fa-search-plus me-1"></i>Нажмите на изображение для просмотра
                                </small>
                            </div>
                        </div>
                        {% endif %}

                        <form id="answerForm" action="{{ url_for('submit_task_answer', tournament_id=tournament.id, task_id=task.id) }}"
                              method="POST"
                              class="mt-4">
                            <div class="mb-3">
                                <label for="answer" class="form-label">Ваш ответ:</label>
                                <input type="text"
                                       class="form-control"
                                       id="answer"
                                       name="answer"
                                       required
                                       autocomplete="off">
                            </div>
                            <div class="text-center">
                                <button type="button" class="btn btn-primary btn-lg" id="submitBtn">
                                    Отправить ответ
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">Подтверждение отправки</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Вы уверены, что хотите отправить ответ?</p>
                <p class="mb-0">Ваш ответ: <strong id="answerPreview"></strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="confirmSubmit">Отправить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для просмотра изображения -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Просмотр изображения</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-0">
                <div class="image-container" id="imageContainer">
                    <div class="modal-image-loading" id="modalImageLoading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка изображения...</span>
                        </div>
                        <p class="mt-2 text-muted">Загрузка изображения...</p>
                    </div>
                    <img src="https://s3.twcstorage.ru/5e984fdc-c435406b-ee7b-4296-aaed-0ceae9456f42/tasks/{{ task.image }}"
                         class="fullscreen-image"
                         alt="Изображение к задаче"
                         id="modalImage"
                         style="display: none;">
                    <div class="modal-image-error" id="modalImageError" style="display: none;">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Ошибка загрузки изображения</strong>
                            <p class="mb-2">Изображение не удалось загрузить</p>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="retryModalImageBtn">
                                <i class="fas fa-redo me-1"></i>Повторить попытку
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения пропуска задачи -->
<div class="modal fade" id="skipTaskModal" tabindex="-1" aria-labelledby="skipTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="skipTaskModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Пропустить задачу
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="fas fa-exclamation-circle text-danger" style="font-size: 3rem;"></i>
                </div>
                <h6 class="text-center mb-3">Вы уверены, что хотите пропустить эту задачу?</h6>
                <div class="alert alert-warning">
                    <strong>Внимание!</strong> Задача будет засчитана как решенная неверно, и вы не получите баллы за неё.
                </div>
                <p class="text-muted small text-center mb-0">
                    После пропуска вам будет выдана новая задача.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="confirmSkipTask">
                    <i class="fas fa-times me-1"></i>Да, пропустить
                </button>
            </div>
        </div>
    </div>
</div>

<style>

/* Стили для компактного таймера и прогресса */
.timer-progress-item {
    min-width: 120px;
}

.countdown-timer-compact {
    font-family: 'Courier New', monospace;
    font-size: 1.2rem;
    font-weight: bold;
    color: #495057;
    background: #f8f9fa;
    padding: 6px 10px;
    border-radius: 6px;
    border: 2px solid #dee2e6;
    display: inline-block;
    min-width: 100px;
    text-align: center;
}

.countdown-timer-compact .countdown-number {
    color: #dc3545;
    font-weight: bold;
}

.progress-compact {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 4px;
    min-width: 100px;
}

.progress-text {
    font-size: 1.2rem;
    font-weight: bold;
    color: #495057;
    background: #f8f9fa;
    padding: 6px 10px;
    border-radius: 6px;
    border: 2px solid #dee2e6;
    display: inline-block;
    min-width: 100px;
    text-align: center;
}

.progress-bar-compact {
    width: 100px;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    border: 1px solid #dee2e6;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #28a745, #20c997);
    border-radius: 3px;
    transition: width 0.3s ease;
}

/* Мобильная адаптация */
@media (max-width: 768px) {
    .timer-progress-item {
        min-width: 80px;
    }
    
    .countdown-timer-compact {
        font-size: 0.9rem;
        padding: 4px 6px;
        min-width: 70px;
    }
    
    .progress-text {
        font-size: 0.9rem;
        padding: 4px 6px;
        min-width: 70px;
    }
    
    .progress-bar-compact {
        width: 70px;
        height: 6px;
    }
    
    .d-flex.justify-content-between {
        flex-direction: row;
        justify-content: space-between;
        gap: 10px;
    }
    
    .timer-progress-item.text-end {
        text-align: right !important;
    }
    
    .progress-compact {
        align-items: flex-end;
    }
    
    .card-body {
        padding: 0.75rem;
    }
}

/* Стили для защиты от копирования */
.no-select {
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    pointer-events: none;
}

/* Стили для изображения задачи */
.task-image {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-radius: 8px;
    border: 2px solid #e9ecef;
}

.task-image:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    border-color: #007bff;
}

/* Стили для контейнера изображения */
.image-container-wrapper {
    position: relative;
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Стили для индикатора загрузки изображения */
.image-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    z-index: 10;
}

.image-loading .spinner-border {
    width: 3rem;
    height: 3rem;
}

/* Стили для ошибки загрузки изображения */
.image-error {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100%;
    max-width: 400px;
    z-index: 10;
}

/* Стили для модального окна изображения */
.modal-image-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    z-index: 10;
}

.modal-image-loading .spinner-border {
    width: 3rem;
    height: 3rem;
}

.modal-image-error {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100%;
    max-width: 400px;
    z-index: 10;
}

/* Стили для модального окна изображения */
#imageModal .modal-dialog {
    max-width: 90vw;
}

#imageModal .modal-body {
    background-color: #f8f9fa;
    overflow: hidden;
    position: relative;
}

#imageModal img {
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

/* Стили для полноэкранного изображения */
.image-container {
    width: 100%;
    height: 70vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f8f9fa;
    border-radius: 8px;
}

.fullscreen-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

/* Мобильные стили */
@media (max-width: 768px) {
    .image-container {
        height: 60vh;
    }
}

.task-content {
    position: relative;
}

/* Добавляем предупреждение при попытке копирования */
.task-content::after {
    content: "Копирование текста запрещено";
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    display: none;
    z-index: 1000;
}


/* Стили для предупреждения о потере фокуса */
.warning-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.warning-content {
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    max-width: 400px;
}

.warning-content h3 {
    color: #dc3545;
    margin-bottom: 15px;
}

.warning-content p {
    margin-bottom: 20px;
}

.warning-content .countdown {
    font-size: 1.2em;
    font-weight: bold;
    color: #dc3545;
}

.warning-content .small {
    font-size: 0.9em;
    color: #666;
}

/* Стили для счетчика задач */
.task-progress {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
}

.task-counter {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.task-number {
    font-size: 2.5rem;
    font-weight: bold;
    color: #17a2b8;
    margin-bottom: 0;
    line-height: 1;
}

.task-label {
    font-size: 0.9rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Компактные стили для прогресса */
.task-progress-compact {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.task-counter-compact {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.task-number-compact {
    font-size: 1.8rem;
    font-weight: bold;
    color: #17a2b8;
    margin-bottom: 0;
    line-height: 1;
}

.task-label-compact {
    font-size: 0.8rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.progress {
    width: 100%;
    height: 8px;
}

/* Увеличенная высота для компактного прогресс-бара */
.task-progress-compact .progress {
    height: 18px;
}

/* Адаптивность для мобильных */
@media (max-width: 768px) {
    .task-number {
        font-size: 2rem;
    }

    .task-number-compact {
        font-size: 1.5rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Объявляем переменные состояния
    let serverTimeOffset = 0; // Смещение между серверным и клиентским временем
    let isSubmitting = false;

    // Скрываем оверлей после полной загрузки страницы
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) {
        loadingOverlay.style.opacity = '0';
        setTimeout(() => {
            loadingOverlay.style.display = 'none';
        }, 300);
    }

    // Инициализация модальных окон
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    const skipTaskModal = new bootstrap.Modal(document.getElementById('skipTaskModal'));
    const answerInput = document.getElementById('answer');
    const answerPreview = document.getElementById('answerPreview');
    const submitBtn = document.getElementById('submitBtn');
    const confirmSubmitBtn = document.getElementById('confirmSubmit');
    const skipTaskBtn = document.getElementById('skipTaskBtn');
    const confirmSkipTaskBtn = document.getElementById('confirmSkipTask');
    const answerForm = document.getElementById('answerForm');

    // Предотвращаем отправку формы по нажатию Enter
    answerInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            return false;
        }
    });

    // Обработчик нажатия на кнопку отправки
    submitBtn.addEventListener('click', function() {
        if (answerInput.value.trim() === '') {
            return;
        }
        answerPreview.textContent = answerInput.value;
        confirmModal.show();
    });

    // Обработчик отправки формы
    answerForm.addEventListener('submit', function(e) {
        e.preventDefault();
        // Показываем модальное окно подтверждения
        confirmModal.show();
    });

    // Обработчик подтверждения отправки
    confirmSubmitBtn.addEventListener('click', function() {
        isSubmitting = true;

        // Показываем оверлей загрузки
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
            // Меняем текст в оверлее
            const loadingText = loadingOverlay.querySelector('p');
            if (loadingText) {
                loadingText.textContent = 'Отправка ответа...';
                // Добавляем дополнительный текст
                const warningText = document.createElement('p');
                warningText.className = 'text-light small mt-2';
                //warningText.textContent = 'Пожалуйста, не закрывайте страницу';
                loadingText.parentNode.appendChild(warningText);
            }

            loadingOverlay.style.display = 'flex';
            setTimeout(() => {
                loadingOverlay.style.opacity = '1';
                // Отправляем форму
                answerForm.submit();
            }, 200);
        } else {
            answerForm.submit();
        }
    });

    // Обработчик нажатия на кнопку "Пропустить задачу"
    skipTaskBtn.addEventListener('click', function() {
        skipTaskModal.show();
    });

    // Обработчик подтверждения пропуска задачи
    confirmSkipTaskBtn.addEventListener('click', function() {
        // Закрываем модальное окно
        skipTaskModal.hide();
        
        // Записываем метку в поле ответа
        answerInput.value = 'wrong_answer_due_to_skip';
        
        // Показываем оверлей загрузки
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
            // Меняем текст в оверлее
            const loadingText = loadingOverlay.querySelector('p');
            if (loadingText) {
                loadingText.textContent = 'Пропуск задачи...';
            }

            loadingOverlay.style.display = 'flex';
            setTimeout(() => {
                loadingOverlay.style.opacity = '1';
                // Отправляем форму
                answerForm.submit();
            }, 200);
        } else {
            answerForm.submit();
        }
    });


    function getServerTime() {
        const clientNow = new Date();
        return new Date(clientNow.getTime() + serverTimeOffset);
    }

    function updateTimer() {
        const startDate = new Date("{{ tournament.start_date.isoformat() }}");
        const tournamentDuration = {{ tournament.duration }}; // длительность в минутах
        const serverNow = getServerTime();

        // Вычисляем время окончания турнира
        const endTime = new Date(startDate.getTime() + tournamentDuration * 60000);
        const timeLeft = endTime - serverNow;

        if (timeLeft <= 0) {
            // Если время вышло, перенаправляем на страницу результатов
            window.location.href = "{{ url_for('tournament_results', tournament_id=tournament.id) }}";
            return;
        }

        // Вычисляем оставшееся время
        const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

        // Обновляем отображение (компактный формат: часы:минуты:секунды)
        document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
        document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
        document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');
    }

    // Инициализация смещения времени при загрузке страницы
    const serverNow = new Date("{{ now.isoformat() }}");
    const clientNow = new Date();
    serverTimeOffset = serverNow.getTime() - clientNow.getTime();

    // Обновляем таймер каждую секунду
    updateTimer();
    setInterval(updateTimer, 1000);

    // Защита от копирования
    const taskContent = document.querySelector('.task-content');
    const warning = document.createElement('div');
    warning.className = 'copy-warning';
    warning.textContent = 'Копирование текста запрещено';
    document.body.appendChild(warning);

    // Предотвращаем контекстное меню
    taskContent.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        showWarning();
    });

    // Предотвращаем выделение текста
    taskContent.addEventListener('selectstart', function(e) {
        e.preventDefault();
        showWarning();
    });

    // Предотвращаем копирование
    taskContent.addEventListener('copy', function(e) {
        e.preventDefault();
        showWarning();
    });

    function showWarning() {
        warning.style.display = 'block';
        setTimeout(() => {
            warning.style.display = 'none';
        }, 2000);
    }

    // Обработка потери фокуса

    function showViolationOverlay() {
        const overlay = document.getElementById('violationOverlay');
        if (overlay) {
            overlay.style.display = 'flex';
            overlay.style.opacity = '1';
        }
    }






    // Обработка загрузки изображений
    function handleImageLoad(imageElement, loadingElement, errorElement, instructionsElement = null) {
        const maxRetries = 3;
        let retryCount = 0;
        let isPreloaded = false;
        
        function attemptLoad() {
            loadingElement.style.display = 'block';
            errorElement.style.display = 'none';
            imageElement.style.display = 'none';
            if (instructionsElement) {
                instructionsElement.style.display = 'none';
            }
            
            // Создаем новый объект Image для проверки загрузки
            const testImage = new Image();
            
            testImage.onload = function() {
                // Изображение загрузилось успешно
                loadingElement.style.display = 'none';
                errorElement.style.display = 'none';
                imageElement.style.display = 'block';
                if (instructionsElement) {
                    instructionsElement.style.display = 'block';
                }
                isPreloaded = true;
            };
            
            testImage.onerror = function() {
                retryCount++;
                if (retryCount < maxRetries) {
                    // Повторная попытка через 1-2 секунды
                    const delay = Math.random() * 1000 + 1000;
                    setTimeout(attemptLoad, delay);
                } else {
                    // Все попытки исчерпаны - показываем ошибку
                    loadingElement.style.display = 'none';
                    errorElement.style.display = 'block';
                    imageElement.style.display = 'none';
                    if (instructionsElement) {
                        instructionsElement.style.display = 'none';
                    }
                }
            };
            
            // Добавляем timestamp для обхода кеша
            const timestamp = new Date().getTime();
            const separator = testImage.src.includes('?') ? '&' : '?';
            testImage.src = imageElement.src + separator + 't=' + timestamp;
        }
        
        // Запускаем первую попытку
        attemptLoad();
        
        // Возвращаем функцию для ручного повтора
        return function() {
            retryCount = 0;
            isPreloaded = false;
            attemptLoad();
        };
    }
    
    // Функция предзагрузки изображения
    function preloadImage(imageUrl) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = () => reject(new Error(`Failed to load image: ${imageUrl}`));
            img.src = imageUrl;
        });
    }
    
    // Обработка основного изображения задачи
    const taskImage = document.getElementById('taskImage');
    
    // Предзагрузка изображения задачи при загрузке страницы
    if (taskImage && taskImage.src) {
        preloadImage(taskImage.src)
            .then(() => {
                console.log('Изображение задачи предзагружено успешно');
            })
            .catch((error) => {
                console.warn('Ошибка предзагрузки изображения задачи:', error.message);
            });
    }
    
    const imageLoading = document.getElementById('imageLoading');
    const imageError = document.getElementById('imageError');
    const imageInstructions = document.getElementById('imageInstructions');
    const retryImageBtn = document.getElementById('retryImageBtn');
    
    if (taskImage && imageLoading && imageError) {
        const retryImageLoad = handleImageLoad(taskImage, imageLoading, imageError, imageInstructions);
        
        // Обработчик кнопки повтора
        if (retryImageBtn) {
            retryImageBtn.addEventListener('click', retryImageLoad);
        }
    }
    
    // Обработка модального окна изображения
    const imageModal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const modalImageLoading = document.getElementById('modalImageLoading');
    const modalImageError = document.getElementById('modalImageError');
    const retryModalImageBtn = document.getElementById('retryModalImageBtn');
    
    if (imageModal && modalImage && modalImageLoading && modalImageError) {
        let retryModalImageLoad = null;
        
        // Обработчик открытия модального окна
        imageModal.addEventListener('show.bs.modal', function() {
            retryModalImageLoad = handleImageLoad(modalImage, modalImageLoading, modalImageError);
        });
        
        // Обработчик кнопки повтора в модальном окне
        if (retryModalImageBtn) {
            retryModalImageBtn.addEventListener('click', function() {
                if (retryModalImageLoad) {
                    retryModalImageLoad();
                }
            });
        }
        
        // Закрытие модального окна по клавише Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = bootstrap.Modal.getInstance(imageModal);
                if (modal && imageModal.classList.contains('show')) {
                    modal.hide();
                }
            }
        });
    }

    // Создаем оверлей предупреждения о потере фокуса
    const warningOverlay = document.createElement('div');
    warningOverlay.className = 'warning-overlay';
    warningOverlay.innerHTML = `
        <div class="warning-content">
            <h3>⚠️ Внимание!</h3>
            <p>Вы покинули страницу с задачей!</p>
            <p>Осталось времени: <span class="countdown">5</span> секунд</p>
            <p class="small">Если не вернетесь, ответ будет засчитан как неправильный</p>
        </div>
    `;
    document.body.appendChild(warningOverlay);

    // Переменные для отслеживания фокуса
    let focusTimeout;
    let isPageFocused = true;
    let warningShown = false;
    let countdownInterval;

    // Функция для отправки неправильного ответа при потере фокуса
    function sendWrongAnswerOnFocusLoss() {
        // Предотвращаем множественные отправки
        if (isSubmitting) {
            return;
        }

        const input = document.getElementById('answer');
        if (input && input.value.trim() === '') {
            // Записываем метку в поле ответа
            input.value = 'wrong_answer_due_to_focus_loss';
            
            // Показываем оверлей нарушения
            showViolationOverlay();
            
            // Автоматически отправляем форму (как будто пользователь нажал кнопку)
            answerForm.submit();
        }
    }

    // Функция для отправки неправильного ответа при переходе на другую страницу
    function sendWrongAnswerOnNavigation() {
        // Предотвращаем множественные отправки
        if (isSubmitting) {
            return;
        }

        const input = document.getElementById('answer');
        if (input && input.value.trim() === '') {
            isSubmitting = true;
            input.value = 'wrong_answer_due_to_navigation';

            // Используем sendBeacon для гарантированной отправки данных
            const formData = new FormData(answerForm);
            navigator.sendBeacon(answerForm.action, formData);

            // Дополнительная попытка через fetch с keepalive
            fetch(answerForm.action, {
                method: 'POST',
                body: formData,
                keepalive: true
            }).catch(() => {
                // Игнорируем ошибки, так как это fallback
            });
        }
    }

    // Функция для запуска обратного отсчета
    function startFocusCountdown() {
        if (warningShown) return;
        
        warningShown = true;
        warningOverlay.style.display = 'flex';
        
        const countdownElement = warningOverlay.querySelector('.countdown');
        let timeLeft = 5;
        countdownElement.textContent = timeLeft;
        
        countdownInterval = setInterval(() => {
            timeLeft--;
            countdownElement.textContent = timeLeft;
            
            if (timeLeft <= 0) {
                clearInterval(countdownInterval);
                sendWrongAnswerOnFocusLoss();
            }
        }, 1000);
    }

    // Функция для остановки обратного отсчета
    function stopFocusCountdown() {
        warningShown = false;
        warningOverlay.style.display = 'none';
        if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
        }
        if (focusTimeout) {
            clearTimeout(focusTimeout);
            focusTimeout = null;
        }
    }

    // Обработчики событий видимости страницы для предупреждения
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            // Страница стала невидимой - запускаем таймер
            focusTimeout = setTimeout(() => {
                startFocusCountdown();
            }, 1000); // 1 секунда задержки
        } else {
            // Страница стала видимой - останавливаем таймер
            stopFocusCountdown();
        }
    });

    // Обработчик потери фокуса окна
    window.addEventListener('blur', function() {
        // Окно потеряло фокус - запускаем таймер
        focusTimeout = setTimeout(() => {
            startFocusCountdown();
        }, 1000); // 1 секунда задержки
    });

    // Обработчик получения фокуса окна
    window.addEventListener('focus', function() {
        // Окно получило фокус - останавливаем таймер
        stopFocusCountdown();
    });

    // Обработчик клика по ссылкам (переход на другие страницы)
    document.addEventListener('click', function(e) {
        if (e.target.tagName === 'A' && !e.target.classList.contains('btn')) {
            // Проверяем, что это не кнопка отправки ответа
            if (!e.target.closest('#answerForm')) {
                sendWrongAnswerOnNavigation();
            }
        }
    });

    // Обработчик перехода на другую страницу
    window.addEventListener('beforeunload', function(e) {
        // Не отправляем неправильный ответ, если идет отправка ответа
        if (isSubmitting) {
            return;
        }

        sendWrongAnswerOnNavigation();
    });

    // Обработчик для pagehide (современный стандарт)
    window.addEventListener('pagehide', function() {
        // Не отправляем неправильный ответ, если идет отправка правильного ответа
        if (!isSubmitting) {
            sendWrongAnswerOnNavigation();
        }
    });
});
</script>
{% endblock %}
