{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="text-center">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—á–∏—Ç–µ–ª—è</h3>
                </div>
                <div class="card-body">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }}">{{ message }}</div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                    
                    <form method="POST" action="{{ url_for('teacher_register') }}" id="teacherRegisterForm">
                        <div class="mb-3">
                            <label for="username" class="form-label">–õ–æ–≥–∏–Ω</label>
                            <div class="input-group">
                            <input type="text" class="form-control" id="username" name="username" required>
                                <span class="input-group-text validation-icon" id="username-icon">
                                    <i class="fas fa-spinner fa-spin" style="display: none;"></i>
                                    <i class="fas fa-check text-success" style="display: none;"></i>
                                    <i class="fas fa-times text-danger" style="display: none;"></i>
                                </span>
                                </div>
                            <div class="form-text">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã –ª–∞—Ç–∏–Ω—Å–∫–æ–≥–æ –∞–ª—Ñ–∞–≤–∏—Ç–∞ (a-z), —Ü–∏—Ñ—Ä—ã (0-9) –∏ –∑–Ω–∞–∫ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è _.</div>
                        </div>

                        <div class="mb-3">
                            <label for="password" class="form-label">–ü–∞—Ä–æ–ª—å</label>
                            <div class="input-group">
                            <input type="password" class="form-control" id="password" name="password" required>
                                <button type="button" class="btn btn-outline-secondary" id="togglePassword" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <span class="input-group-text validation-icon" id="password-icon">
                                    <i class="fas fa-check text-success" style="display: none;"></i>
                                    <i class="fas fa-times text-danger" style="display: none;"></i>
                                </span>
                            </div>
                            <div class="password-requirements mt-2" id="password-requirements">
                                <small class="text-muted">–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–∞—Ä–æ–ª—é:</small>
                                <ul class="list-unstyled mt-1 mb-0">
                                    <li id="req-length"><i class="fas fa-circle text-muted"></i> –ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤</li>
                                    <li id="req-uppercase"><i class="fas fa-circle text-muted"></i> –ó–∞–≥–ª–∞–≤–Ω–∞—è –±—É–∫–≤–∞</li>
                                    <li id="req-lowercase"><i class="fas fa-circle text-muted"></i> –°—Ç—Ä–æ—á–Ω–∞—è –±—É–∫–≤–∞</li>
                                    <li id="req-number"><i class="fas fa-circle text-muted"></i> –¶–∏—Ñ—Ä–∞</li>
                                    <li id="req-special"><i class="fas fa-circle text-muted"></i> –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–∏–º–≤–æ–ª (!@#$%^&*()_+-=[]{}|;:,.<>?)</li>
                                </ul>
                                </div>
                        </div>

                        <div class="mb-3">
                            <label for="confirm_password" class="form-label">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                            <div class="input-group">
                            <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                                <button type="button" class="btn btn-outline-secondary" id="toggleConfirmPassword" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <span class="input-group-text validation-icon" id="confirm_password-icon">
                                    <i class="fas fa-check text-success" style="display: none;"></i>
                                    <i class="fas fa-times text-danger" style="display: none;"></i>
                                </span>
                                </div>
                        </div>

                        <hr class="my-4" style="border: 2px solid grey; border-radius: 1px; opacity: 0.8; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        
                        <div class="mb-3">
                            <label for="full_name" class="form-label">–§–∞–º–∏–ª–∏—è, –∏–º—è, –æ—Ç—á–µ—Å—Ç–≤–æ</label>
                            <div class="input-group">
                            <input type="text" class="form-control" id="full_name" name="full_name" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á" required>
                                <span class="input-group-text validation-icon" id="full_name-icon">
                                    <i class="fas fa-check text-success" style="display: none;"></i>
                                    <i class="fas fa-times text-danger" style="display: none;"></i>
                                </span>
                                </div>
                            <div class="form-text">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–∏ —Ñ–∞–º–∏–ª–∏—é, –∏–º—è –∏ –æ—Ç—á–µ—Å—Ç–≤–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ú–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞.</div>
                        </div>

                        <div class="mb-3">
                            <label for="phone" class="form-label">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                            <div class="input-group">
                                <select class="form-select" id="phone_country" style="max-width: 120px;">
                                    <option value="+375">üáßüáæ +375</option>
                                    <option value="+7">üá∑üá∫ +7</option>
                                </select>
                                <input type="tel" class="form-control" id="phone" name="phone" placeholder="291234567" required>
                                <span class="input-group-text validation-icon" id="phone-icon">
                                    <i class="fas fa-spinner fa-spin" style="display: none;"></i>
                                    <i class="fas fa-check text-success" style="display: none;"></i>
                                    <i class="fas fa-times text-danger" style="display: none;"></i>
                                </span>
                                </div>
                            <div class="form-text">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –±–µ–∑ –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω—ã. –ü—Ä–∏–º–µ—Ä: 291234567</div>
                        </div>

                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <div class="input-group">
                            <input type="email" class="form-control" id="email" name="email" placeholder="example@email.com" required>
                                <span class="input-group-text validation-icon" id="email-icon">
                                    <i class="fas fa-spinner fa-spin" style="display: none;"></i>
                                    <i class="fas fa-check text-success" style="display: none;"></i>
                                    <i class="fas fa-times text-danger" style="display: none;"></i>
                                </span>
                                </div>
                            <div class="form-text">–ù–∞ —ç—Ç–æ—Ç –∞–¥—Ä–µ—Å –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–∏—Å—å–º–æ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</div>
                        </div>

                        <!-- –ü–æ–ª–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —É—á—Ä–µ–∂–¥–µ–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è -->
                        <div class="mb-3">
                            <label for="educational_institution" class="form-label">–£—á—Ä–µ–∂–¥–µ–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="educational_institution_search" 
                                       placeholder="–°—Ä–µ–¥–Ω—è—è —à–∫–æ–ª–∞ ‚Ññ2 –≥. –ì—Ä–æ–¥–Ω–æ" autocomplete="off">
                                <span class="input-group-text validation-icon" id="educational_institution-icon">
                                    <i class="fas fa-check text-success" style="display: none;"></i>
                                    <i class="fas fa-times text-danger" style="display: none;"></i>
                                </span>
                                </div>
                            
                            <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è ID –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —É—á—Ä–µ–∂–¥–µ–Ω–∏—è -->
                            <input type="hidden" id="educational_institution_id" name="educational_institution_id">
                            
                            <!-- –ü–æ–ª–µ –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —É—á—Ä–µ–∂–¥–µ–Ω–∏—è -->
                            <input type="hidden" id="educational_institution_name" name="educational_institution_name">
                            
                            <!-- –°–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ -->
                            <div id="institution_results" class="list-group position-absolute w-100" style="z-index: 1000; display: none; max-height: 200px; overflow-y: auto;"></div>
                            
                            <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ —É—á—Ä–µ–∂–¥–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</div>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="agree_terms" name="agree_terms" required>
                            <label class="form-check-label" for="agree_terms">
                                –ú–Ω–µ —Ä–∞–∑—ä—è—Å–Ω–µ–Ω—ã <a href="{{ url_for('rights_notification_pdf') }}" target="_blank" class="text-decoration-none">–ø—Ä–∞–≤–∞</a> –º–æ–∏ –ø—Ä–∞–≤–∞, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ —è <a href="{{ url_for('teacher_consent_pdf') }}" target="_blank" class="text-decoration-none">—Å–æ–≥–ª–∞—Å–µ–Ω (–Ω–∞)</a> –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –º–æ–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                            </label>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="registerButton">
                                <i class="fas fa-user-plus me-2"></i>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ —É—á–∏—Ç–µ–ª—å
                            </button>
                        </div>
                    </form>

                    <div class="text-center mt-3">
                        <p class="mb-0">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="/login" class="text-decoration-none">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</a></p>
                        <p class="mb-0">–í—ã —É—á–µ–Ω–∏–∫? <a href="/register" class="text-decoration-none">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–ª—è —É—á–µ–Ω–∏–∫–æ–≤</a></p>
                    </div>
                    
                    <div class="text-center mt-4">
                        <a href="{{ url_for('cooperation') }}" class="btn btn-outline-warning cooperation-btn" style="color: #FF8C00; border-color: #FF8C00;">
                            <i class="fas fa-handshake me-2"></i>–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –æ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–µ
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –û–≤–µ—Ä–ª–µ–π –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
<div id="registerOverlay" class="loading-overlay">
    <div class="loading-spinner">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
        <p class="mt-3">–°–æ–∑–¥–∞–µ—Ç—Å—è –∞–∫–∫–∞—É–Ω—Ç —É—á–∏—Ç–µ–ª—è...</p>
        <p class="text-light small">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É</p>
    </div>
</div>

<style>
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    color: white;
}

.loading-spinner {
    text-align: center;
}

.password-requirements li {
    transition: all 0.3s ease;
}

.password-requirements li.valid {
    color: #28a745 !important;
}

.password-requirements li.valid i {
    color: #28a745 !important;
}

.password-requirements li.invalid {
    color: #dc3545 !important;
}

.password-requirements li.invalid i {
    color: #dc3545 !important;
}

.validation-icon {
    width: 40px;
}

.cooperation-btn:hover {
    color: #000 !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –§—É–Ω–∫—Ü–∏–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –æ–±—ã—á–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
    const form = document.getElementById('teacherRegisterForm');
    const usernameField = document.getElementById('username');
    const passwordField = document.getElementById('password');
    const confirmPasswordField = document.getElementById('confirm_password');
    const fullNameField = document.getElementById('full_name');
    const phoneField = document.getElementById('phone');
    const emailField = document.getElementById('email');
    const agreeTermsField = document.getElementById('agree_terms');
    const submitButton = document.getElementById('registerButton');
    const overlay = document.getElementById('registerOverlay');

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ª–æ–≥–∏–Ω–∞
    function validateUsername() {
        const username = usernameField.value;
        const icon = document.querySelector('#username-icon');
        const spinner = icon.querySelector('.fa-spinner');
        const check = icon.querySelector('.fa-check');
        const times = icon.querySelector('.fa-times');
        
        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∏–∫–æ–Ω–∫–∏
        spinner.style.display = 'none';
        check.style.display = 'none';
        times.style.display = 'none';
        
        if (username.length < 3) {
            times.style.display = 'inline';
            return false;
        }
        
        if (!/^[a-zA-Z0-9_]+$/.test(username)) {
            times.style.display = 'inline';
            return false;
        }
        
        if (!/[a-zA-Z]/.test(username)) {
            times.style.display = 'inline';
            return false;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ª–æ–≥–∏–Ω–∞
        spinner.style.display = 'inline';
        
        fetch('/check-username', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({username: username, type: 'teacher'})
        })
        .then(response => response.json())
        .then(data => {
            spinner.style.display = 'none';
            if (data.available) {
                check.style.display = 'inline';
                usernameField.isValid = true;
            } else {
                times.style.display = 'inline';
                usernameField.isValid = false;
            }
            checkFormValidity();
        })
        .catch(error => {
            spinner.style.display = 'none';
            times.style.display = 'inline';
            usernameField.isValid = false;
            checkFormValidity();
        });
        
        return true;
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è
    function validatePassword() {
        const password = passwordField.value;
        const icon = document.querySelector('#password-icon');
        const check = icon.querySelector('.fa-check');
        const times = icon.querySelector('.fa-times');
        
        let isValid = true;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É
        const lengthReq = document.getElementById('req-length');
        if (password.length >= 8) {
            lengthReq.classList.remove('invalid');
            lengthReq.classList.add('valid');
        } else {
            lengthReq.classList.remove('valid');
            lengthReq.classList.add('invalid');
            isValid = false;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥–ª–∞–≤–Ω—ã–µ –±—É–∫–≤—ã
        const uppercaseReq = document.getElementById('req-uppercase');
        if (/[A-Z]/.test(password)) {
            uppercaseReq.classList.remove('invalid');
            uppercaseReq.classList.add('valid');
        } else {
            uppercaseReq.classList.remove('valid');
            uppercaseReq.classList.add('invalid');
            isValid = false;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä–æ—á–Ω—ã–µ –±—É–∫–≤—ã
        const lowercaseReq = document.getElementById('req-lowercase');
        if (/[a-z]/.test(password)) {
            lowercaseReq.classList.remove('invalid');
            lowercaseReq.classList.add('valid');
        } else {
            lowercaseReq.classList.remove('valid');
            lowercaseReq.classList.add('invalid');
            isValid = false;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–∏—Ñ—Ä—ã
        const numberReq = document.getElementById('req-number');
        if (/[0-9]/.test(password)) {
            numberReq.classList.remove('invalid');
            numberReq.classList.add('valid');
        } else {
            numberReq.classList.remove('valid');
            numberReq.classList.add('invalid');
            isValid = false;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
        const specialReq = document.getElementById('req-special');
        if (/[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/.test(password)) {
            specialReq.classList.remove('invalid');
            specialReq.classList.add('valid');
        } else {
            specialReq.classList.remove('valid');
            specialReq.classList.add('invalid');
            isValid = false;
        }
        
        check.style.display = 'none';
        times.style.display = 'none';
        
        if (password.length > 0) {
            if (isValid) {
                check.style.display = 'inline';
            } else {
                times.style.display = 'inline';
            }
        }
        
        passwordField.isValid = isValid;
        validateConfirmPassword(); // –ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è
        return isValid;
    }
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è
    function validateConfirmPassword() {
        const password = passwordField.value;
        const confirmPassword = confirmPasswordField.value;
        const icon = document.querySelector('#confirm_password-icon');
        const check = icon.querySelector('.fa-check');
        const times = icon.querySelector('.fa-times');
        
        check.style.display = 'none';
        times.style.display = 'none';
        
        if (confirmPassword.length > 0) {
            if (password === confirmPassword && passwordField.isValid) {
                check.style.display = 'inline';
                confirmPasswordField.isValid = true;
            } else {
                times.style.display = 'inline';
                confirmPasswordField.isValid = false;
            }
        } else {
            confirmPasswordField.isValid = false;
        }
        
        return confirmPasswordField.isValid;
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –§–ò–û
    function validateFullName() {
        const fullName = fullNameField.value;
        const icon = document.querySelector('#full_name-icon');
        const check = icon.querySelector('.fa-check');
        const times = icon.querySelector('.fa-times');
        
        check.style.display = 'none';
        times.style.display = 'none';
        
        if (fullName.length >= 2 && /^[–∞-—è—ë–ê-–Ø–Å\s\-\.]+$/.test(fullName)) {
            check.style.display = 'inline';
            fullNameField.isValid = true;
        } else if (fullName.length > 0) {
            times.style.display = 'inline';
            fullNameField.isValid = false;
        } else {
            fullNameField.isValid = false;
        }
        
        return fullNameField.isValid;
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    function validatePhone() {
        const phone = phoneField.value;
        const phoneCountry = document.getElementById('phone_country').value;
        const icon = document.querySelector('#phone-icon');
        const spinner = icon.querySelector('.fa-spinner');
        const check = icon.querySelector('.fa-check');
        const times = icon.querySelector('.fa-times');
        
        spinner.style.display = 'none';
        check.style.display = 'none';
        times.style.display = 'none';
        
        let isValid = false;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–≤–µ–¥–µ–Ω—ã —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
        if (!/^[0-9]+$/.test(phone)) {
            isValid = false;
        } else if (phoneCountry === '+375' && /^[0-9]{9}$/.test(phone)) {
            isValid = true;
        } else if (phoneCountry === '+7' && /^[0-9]{10}$/.test(phone)) {
            isValid = true;
        }
        
        if (!isValid) {
            if (phone.length > 0) {
                times.style.display = 'inline';
            }
            phoneField.isValid = false;
            checkFormValidity();
            return false;
        }
        
        // –ï—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ, –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å
        if (!phone || phone.trim() === '' || phone.length < 9) {
            phoneField.isValid = false;
            checkFormValidity();
            return false;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        const fullPhone = phoneCountry + phone;
        spinner.style.display = 'inline';
        
        fetch('/check-phone', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({phone: fullPhone, type: 'teacher'})
        })
        .then(async response => {
            if (response.status === 429) {
                const retryAfter = response.headers.get('Retry-After');
                const waitMsg = retryAfter ? `–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É —á–µ—Ä–µ–∑ ${retryAfter} —Å–µ–∫—É–Ω–¥` : '–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É —á—É—Ç—å –ø–æ–∑–∂–µ';
                spinner.style.display = 'none';
                times.style.display = 'inline';
                phoneField.isValid = false;
                console.warn('–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –ø—Ä–æ–≤–µ—Ä–æ–∫ —Ç–µ–ª–µ—Ñ–æ–Ω–∞. ' + waitMsg);
                if (typeof showNotification === 'function') {
                    showNotification('–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫', waitMsg, 'warning');
                }
                return { available: false };
            }
            return response.json();
        })
        .then(data => {
            spinner.style.display = 'none';
            if (data.available) {
                check.style.display = 'inline';
                phoneField.isValid = true;
            } else {
                times.style.display = 'inline';
                phoneField.isValid = false;
            }
            checkFormValidity();
        })
        .catch(error => {
            spinner.style.display = 'none';
            times.style.display = 'inline';
            phoneField.isValid = false;
            checkFormValidity();
        });
        
        return true;
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è email
    function validateEmail() {
        const email = emailField.value;
        const icon = document.querySelector('#email-icon');
        const spinner = icon.querySelector('.fa-spinner');
        const check = icon.querySelector('.fa-check');
        const times = icon.querySelector('.fa-times');
        
        spinner.style.display = 'none';
        check.style.display = 'none';
        times.style.display = 'none';
        
        if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            if (email.length > 0) {
                times.style.display = 'inline';
            }
            emailField.isValid = false;
            return false;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å email
        spinner.style.display = 'inline';
        
        // –î–µ–±–∞—É–Ω—Å –∏ —á–∞—Å—Ç–æ—Ç–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ —É–∂–µ –µ—Å—Ç—å; –ø—Ä–æ—Å—Ç–æ –æ–±—Ä–∞—â–∞–µ–º—Å—è –∫ API
        fetch('/check-email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({email: email, type: 'teacher'})
        })
        .then(async response => {
            if (response.status === 429) {
                const retryAfter = response.headers.get('Retry-After');
                const waitMsg = retryAfter ? `–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É —á–µ—Ä–µ–∑ ${retryAfter} —Å–µ–∫—É–Ω–¥` : '–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É —á—É—Ç—å –ø–æ–∑–∂–µ';
                spinner.style.display = 'none';
                times.style.display = 'inline';
                emailField.isValid = false;
                console.warn('–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –ø—Ä–æ–≤–µ—Ä–æ–∫ email. ' + waitMsg);
                if (typeof showNotification === 'function') {
                    showNotification('–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫', waitMsg, 'warning');
                }
                return { available: false };
            }
            return response.json();
        })
        .then(data => {
            spinner.style.display = 'none';
            if (data.available) {
                check.style.display = 'inline';
                emailField.isValid = true;
            } else {
                times.style.display = 'inline';
                emailField.isValid = false;
            }
            checkFormValidity();
        })
        .catch(error => {
            spinner.style.display = 'none';
            times.style.display = 'inline';
            emailField.isValid = false;
            checkFormValidity();
        });
        
        return true;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—â–µ–π –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ñ–æ—Ä–º—ã
    function checkFormValidity() {
        const isValid = usernameField.isValid && 
                       passwordField.isValid && 
                       confirmPasswordField.isValid && 
                       fullNameField.isValid && 
                       phoneField.isValid && 
                       emailField.isValid && 
                       agreeTermsField.checked;
        
        submitButton.disabled = !isValid;
        
        if (isValid) {
            submitButton.classList.remove('btn-secondary');
            submitButton.classList.add('btn-primary');
        } else {
            submitButton.classList.remove('btn-primary');
            submitButton.classList.add('btn-secondary');
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    usernameField.addEventListener('input', validateUsername);
    passwordField.addEventListener('input', validatePassword);
    confirmPasswordField.addEventListener('input', validateConfirmPassword);
    fullNameField.addEventListener('input', validateFullName);
    
    // –î–µ–±–∞—É–Ω—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    let phoneTimeout;
    phoneField.addEventListener('input', function() {
        clearTimeout(phoneTimeout);
        
        // –ï—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ, —Å—Ä–∞–∑—É —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        if (!this.value || this.value.trim() === '') {
            const icon = document.querySelector('#phone-icon');
            const spinner = icon.querySelector('.fa-spinner');
            const check = icon.querySelector('.fa-check');
            const times = icon.querySelector('.fa-times');
            
            spinner.style.display = 'none';
            check.style.display = 'none';
            times.style.display = 'none';
            
            phoneField.isValid = false;
            checkFormValidity();
            return;
        }
        
        phoneTimeout = setTimeout(() => {
            validatePhone();
        }, 500);
    });
    
    emailField.addEventListener('input', validateEmail);
    agreeTermsField.addEventListener('change', checkFormValidity);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω—ã –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    document.getElementById('phone_country').addEventListener('change', function() {
        updatePhonePlaceholder();
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω—ã
        const icon = document.querySelector('#phone-icon');
        const spinner = icon.querySelector('.fa-spinner');
        const check = icon.querySelector('.fa-check');
        const times = icon.querySelector('.fa-times');
        
        spinner.style.display = 'none';
        check.style.display = 'none';
        times.style.display = 'none';
        
        phoneField.isValid = false;
        checkFormValidity();
        
        // –ï—Å–ª–∏ –≤ –ø–æ–ª–µ –µ—Å—Ç—å –Ω–æ–º–µ—Ä, –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ–≥–æ —Å –Ω–æ–≤—ã–º –∫–æ–¥–æ–º —Å—Ç—Ä–∞–Ω—ã
        if (phoneField.value.trim() !== '') {
            validatePhone();
        }
    });
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    function updatePhonePlaceholder() {
        const countryCode = document.getElementById('phone_country').value;
        const phoneInput = document.getElementById('phone');
        
        if (countryCode === '+375') {
            // –ë–µ–ª–∞—Ä—É—Å—å: 9 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ –∫–æ–¥–∞
            phoneInput.placeholder = '291234567';
        } else if (countryCode === '+7') {
            // –†–æ—Å—Å–∏—è: 10 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ –∫–æ–¥–∞
            phoneInput.placeholder = '9123456789';
        }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    updatePhonePlaceholder();
    
    // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å
    document.getElementById('togglePassword').addEventListener('click', function() {
        const passwordField = document.getElementById('password');
        const icon = this.querySelector('i');
        
        if (passwordField.type === 'password') {
            passwordField.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            passwordField.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    });

    document.getElementById('toggleConfirmPassword').addEventListener('click', function() {
        const confirmPasswordField = document.getElementById('confirm_password');
        const icon = this.querySelector('i');
        
        if (confirmPasswordField.type === 'password') {
            confirmPasswordField.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            confirmPasswordField.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    });

    // –ê–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç –¥–ª—è —É—á–µ–±–Ω—ã—Ö –∑–∞–≤–µ–¥–µ–Ω–∏–π
    const searchField = document.getElementById('educational_institution_search');
    const resultsContainer = document.getElementById('institution_results');
    const institutionIdField = document.getElementById('educational_institution_id');
    const institutionNameField = document.getElementById('educational_institution_name');
    
    let searchTimeout;
    
    searchField.addEventListener('input', function() {
        const query = this.value.trim();
        
        clearTimeout(searchTimeout);
        
        if (query.length < 2) {
            resultsContainer.style.display = 'none';
            institutionIdField.value = '';
            institutionNameField.value = '';
            return;
        }
        
        searchTimeout = setTimeout(() => {
            fetch(`/api/search-educational-institutions?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    resultsContainer.innerHTML = '';
                    
                    if (data.institutions.length > 0) {
                        data.institutions.forEach(institution => {
                            const item = document.createElement('button');
                            item.type = 'button';
                            item.className = 'list-group-item list-group-item-action';
                            item.innerHTML = `
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">${institution.name}</h6>
                                </div>
                                <p class="mb-1">${institution.address}</p>
                            `;
                            
                            item.addEventListener('click', function() {
                                searchField.value = institution.name;
                                institutionIdField.value = institution.id;
                                institutionNameField.value = '';
                                resultsContainer.style.display = 'none';
                            });
                            
                            resultsContainer.appendChild(item);
                        });
                        
                        resultsContainer.style.display = 'block';
                    } else {
                        // –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ —É—á—Ä–µ–∂–¥–µ–Ω–∏–µ
                        const item = document.createElement('button');
                        item.type = 'button';
                        item.className = 'list-group-item list-group-item-action text-muted';
                        item.innerHTML = `
                            <div class="text-center">
                                <i class="fas fa-plus me-2"></i>
                                –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ: "${query}"
                            </div>
                        `;
                        
                        item.addEventListener('click', function() {
                            searchField.value = query;
                            institutionIdField.value = '';
                            institutionNameField.value = query;
                            resultsContainer.style.display = 'none';
                        });
                        
                        resultsContainer.appendChild(item);
                        resultsContainer.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
                    resultsContainer.style.display = 'none';
                });
        }, 300);
    });

    // –°–∫—Ä—ã—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏
    document.addEventListener('click', function(e) {
        if (!searchField.contains(e.target) && !resultsContainer.contains(e.target)) {
            resultsContainer.style.display = 'none';
        }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!submitButton.disabled) {
            overlay.style.display = 'flex';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã –∫ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞
            const phoneCountry = document.getElementById('phone_country').value;
            const phoneNumber = phoneField.value;
            const fullPhone = phoneCountry + phoneNumber;
            
            // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
            const hiddenPhoneField = document.createElement('input');
            hiddenPhoneField.type = 'hidden';
            hiddenPhoneField.name = 'phone_country';
            hiddenPhoneField.value = phoneCountry;
            form.appendChild(hiddenPhoneField);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
            form.submit();
        }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –ø–æ–ª–µ–π
    usernameField.isValid = false;
    passwordField.isValid = false;
    confirmPasswordField.isValid = false;
    fullNameField.isValid = false;
    phoneField.isValid = false;
    emailField.isValid = false;
    
    checkFormValidity();
});
</script>
{% endblock %} 